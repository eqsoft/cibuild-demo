---
variables:
  CIBUILDER_IMAGE: "${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/stack4ops/cibuilder"
  #CIBUILDER_IMAGE: "docker.io/stack4ops/cibuilder"
  CIBUILDER_REF: "rootless"

image: "${CIBUILDER_IMAGE}:${CIBUILDER_REF}"

workflow:
  rules:
    # Trigger rules:
    # The default CI_PIPELINE_SOURCE trigger is schedule
    # Edit or comment in other trigger below

    # Create a pipline on schedules
    - if: $CI_PIPELINE_SOURCE == "schedule"

    # Create a pipline on every push commit
    - if: $CI_PIPELINE_SOURCE == "push"

    # Create a pipeline on merge_requests_event
    # - if: $CI_PIPELINE_SOURCE == "merge_request_event"

    # Create a pipline on web "Run pipline"
    # - if: $CI_PIPELINE_SOURCE == "web" 

    # Example: Create pipeline on every push on every branch except main branch
    # - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
    #   when: never

stages:
  - all
  
all:
  stage: all
  variables:
    # all: defaults to build and deploy run. 
    # check and test runs can be enabled by CIBUILD_BUILD_CHECK_ENABLED=1, CIBUILD_BUILD_TEST_ENABLED=1
    CIBUILD_RUN_CMD: all
    # CIBUILD_TARGET_REGISTRY_USER and CIBUILD_TARGET_REGISTRY_PASS are defined as masked CI variables
    CIBUILD_TARGET_REGISTRY: docker.io
    CIBUILD_TARGET_IMAGE_PATH: stack4ops/as-generic-demo
    # available template placeholder:
    # __REF__ __COMMIT__ __DATE__ __DATE_TIME__
    # here: target tag = latest-BRANCHNAME
    CIBUILD_TARGET_TAG: latest-__REF__
    # deploy additional tags comma seperated list
    # here: commit-digest as additional tag
    CIBUILD_DEPLOY_ADDITIONAL_TAGS: __COMMIT__
    
  script:
    - /bin/true
  tags:
    - saas-linux-medium-amd64
