#!/usr/bin/env bash
set -euo pipefail

RUN_CMD="$1"
BIN_REF="$2"
IMAGE="$3"

cat <<EOF > github.env
GITHUB_SHA=$GITHUB_SHA
GITHUB_REF=$GITHUB_REF
GITHUB_REF_NAME=$GITHUB_REF_NAME
GITHUB_RUN_ID=$GITHUB_RUN_ID
GITHUB_REPOSITORY=$GITHUB_REPOSITORY
GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME
GITHUB_ACTOR=$GITHUB_ACTOR
GITHUB_TOKEN=$GITHUB_TOKEN
CIBUILDER_BIN_REF=$BIN_REF
CIBUILD_RUN_CMD=$RUN_CMD
CIBUILD_CANCEL_TOKEN=$CIBUILD_CANCEL_TOKEN
CIBUILD_BASE_REGISTRY_PASS=$CIBUILD_BASE_REGISTRY_PASS
CIBUILD_TARGET_REGISTRY_PASS=$CIBUILD_TARGET_REGISTRY_PASS
CIBUILD_BUILD_BUILDKIT_CLIENT_KEY=$CIBUILD_BUILD_BUILDKIT_CLIENT_KEY
CIBUILD_BUILD_BUILDKIT_SERVICE_ACCOUNT=$CIBUILD_BUILD_BUILDKIT_SERVICE_ACCOUNT
CIBUILD_TEST_SERVICE_ACCOUNT=$CIBUILD_TEST_SERVICE_ACCOUNT
EOF

docker run --privileged --rm \
  --env-file github.env \
  -v "$PWD:/workspace" \
  -w /workspace \
  "$IMAGE"
